USE MASTER 
GO

USE Ej_N4
go


CREATE TABLE PROVEEDORES(
    P# varchar(5), 
    Pnombre varchar(60), 
    Categoria int, 
    Ciudad varchar(25)
    Constraint pk_p# PRIMARY KEY(P#),
);

CREATE TABLE COMPONENTES(
    C# varchar(5), 
    Cnombre varchar(60), 
    Color varchar(20),
    Peso float, 
    Ciudad varchar(30),
    Constraint pk_c# PRIMARY KEY(C#),
);

CREATE TABLE ARTICULOS(
    T# varchar(5),
    Tnombre varchar(25),
    Ciudad varchar(30),
    Constraint pk_t# PRIMARY KEY(T#),
);

CREATE TABLE ENVIOS(
    P# varchar(5),
    C# varchar(5),
    T# varchar(5),
    Cantidad int,
    CONSTRAINT fk_p#_e FOREIGN KEY (P#) REFERENCES PROVEEDORES(P#),
    CONSTRAINT fk_c#_e FOREIGN KEY (C#) REFERENCES COMPONENTES(C#),
    CONSTRAINT fk_t#_e FOREIGN KEY (T#) REFERENCES ARTICULOS(T#)
);

INSERT INTO PROVEEDORES VALUES
    ('P1','CARLOS', 20,'SEVILLA'),
    ('P2', 'JUAN', 10, 'MADRID'),
    ('P3','JOSE',30,'SEVILLA'),
    ('P4','INMA',20,'SEVILLA'),
    ('P5','EVA',30,'CACERES');

INSERT INTO COMPONENTES VALUES
    ('C1','X3A','ROJO',12,'SEVILLA'),
    ('C2','B85','VERDE',17,'MADRID'),
    ('C3','C4B','AZUL',17,'MALAGA'),
    ('C4','C4B','ROJO',14,'SEVILLA'),
    ('C5','VT8','AZUL',12,'MADRID'),
    ('C6','C30','ROJO',19,'SEVILLA');

INSERT INTO ARTICULOS VALUES
    ('T1','CLASIFICADORA','MADRID'),
    ('T2','PERFORADORA','MALAGA'),
    ('T3','LECTORA','CACERES'),
    ('T4','CONSOLA','CACERES'),
    ('T5','MEZCLADORA','SEVILLA'),
    ('T6','TERMINAL','BARCELONA'),
    ('T7','CINTA','SEVILLA');
     
INSERT INTO ENVIOS VALUES
    ('P1','C1','T1',200),
    ('P1','C1','T4',700),
    ('P2','C3','T1',400),
    ('P2','C3','T2',200),
	('P2','C3','T3',200),
    ('P2','C3','T4',500),
    ('P2','C3','T5',600),
    ('P2','C3','T6',400),
    ('P2','C3','T7',800),
    ('P2','C5','T2',100),
    ('P3','C3','T1',200),
    ('P3','C4','T2',500),
    ('P4','C6','T2',500),
    ('P4','C6','T7',300),
    ('P5','C2','T2',200),
    ('P5','C2','T4',100),
    ('P5','C5','T4',500),
    ('P5','C5','T7',100),
    ('P5','C6','T2',200),
    ('P5','C1','T4',100),
    ('P5','C3','T4',200),
    ('P5','C4','T4',800),
    ('P5','C5','T5',400),
    ('P5','C6','T4',500);

select * from ARTICULOS
Where Ciudad='CACERES'

SELECT P# 
FROM ENVIOS
WHERE T#='T1'

SELECT DISTINCT Color,Ciudad FROM COMPONENTES

SELECT T#,Ciudad 
FROM ARTICULOS
WHERE Ciudad LIKE '%D' 
OR Ciudad LIKE '%E%'


 SELECT P# 
 FROM ENVIOS
 WHERE T#='T1' AND C#='C1'

SELECT TNOMBRE 
FROM ARTICULOS
INNER JOIN ENVIOS ON ENVIOS.T# = ARTICULOS.T#
WHERE ENVIOS.P#='P1'
ORDER BY TNOMBRE ASC

SELECT TNOMBRE 
  FROM ARTICULOS a,ENVIOS e 
 WHERE e.P# = 'P1' 
   AND e.T# = a.T# 
 ORDER BY TNOMBRE; 

SELECT DISTINCT ENVIOS.C#
FROM ENVIOS
INNER JOIN COMPONENTES ON ENVIOS.C# = COMPONENTES.C#
INNER JOIN ARTICULOS ON ENVIOS.T# = ARTICULOS.T#
WHERE ARTICULOS.Ciudad= 'MADRID'

SELECT DISTINCT C# 
  FROM ENVIOS 
 WHERE T# IN (SELECT T# FROM ARTICULOS WHERE CIUDAD = 'MADRID'); 


SELECT C# 
FROM COMPONENTES
WHERE PESO= (SELECT MIN(PESO) FROM COMPONENTES)



SELECT DISTINCT P#
FROM ENVIOS
WHERE T# IN ('T1','T2')


SELECT P# 
  FROM ENVIOS 
 WHERE T# = 'T1' 
INTERSECT 
SELECT P# 
  FROM ENVIOS 
 WHERE T# = 'T2'; 


SELECT DISTINCT P#
FROM ENVIOS
INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#
INNER JOIN COMPONENTES ON ENVIOS.C# = COMPONENTES.C#
WHERE ARTICULOS.Ciudad IN ('SEVILLA','MADRID')
AND COMPONENTES.Color= 'ROJO' 
 
SELECT P# 
FROM ENVIOS e, COMPONENTES c, ARTICULOS a 
WHERE e.C# = c.C# 
AND e.T# = a.T# 
AND c.Color = 'ROJO' 
AND a.Ciudad IN ('SEVILLA', 'MADRID'); 


SELECT C#
FROM ENVIOS
INNER JOIN PROVEEDORES ON PROVEEDORES.P# = ENVIOS.P#
INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#
WHERE ARTICULOS.Ciudad='SEVILLA'
AND PROVEEDORES.Ciudad='SEVILLA'

SELECT C# 
  FROM ENVIOS
 WHERE T# IN (SELECT T# FROM ARTICULOS WHERE Ciudad = 'SEVILLA') 
   AND P# IN (SELECT P# FROM PROVEEDORES WHERE Ciudad = 'SEVILLA'); 


SELECT DISTINCT T#
FROM ENVIOS
WHERE P#='P1'

SELECT DISTINCT T# 
  FROM ENVIOS
 WHERE C# IN (SELECT DISTINCT C# FROM ENVIOS WHERE P# = 'P1'); 


 SELECT PROVEEDORES.Ciudad,C#,ARTICULOS.Ciudad
 FROM ENVIOS
 INNER JOIN PROVEEDORES ON PROVEEDORES.P# = ENVIOS.P#
 INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#

 SELECT PROVEEDORES.Ciudad,C#,ARTICULOS.Ciudad
 FROM ENVIOS
 INNER JOIN PROVEEDORES ON PROVEEDORES.P# = ENVIOS.P#
 INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#
 WHERE NOT PROVEEDORES.Ciudad = ARTICULOS.Ciudad



SELECT *
FROM ENVIOS
WHERE P#='P2'
ORDER BY C#

SELECT COUNT(C#) AS [NUMERO DE COMPONENTES], 
COUNT(DISTINCT T#) AS [NUMERO DE ARTICULOS],
SUM(Cantidad) AS [Total de artículos suministrados]
FROM ENVIOS
WHERE P#='P2'

SELECT C#, T#, SUM(CANTIDAD) AS [cantidad total]
FROM ENVIOS
GROUP BY C#,T#


SELECT DISTINCT ENVIOS.T#
FROM ENVIOS
INNER JOIN PROVEEDORES ON PROVEEDORES.P# = ENVIOS.P#
INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#
WHERE PROVEEDORES.Ciudad<>'MADRID'
AND PROVEEDORES.Ciudad<>ARTICULOS.Ciudad

SELECT DISTINCT e.T# 
  FROM ENVIOS e, ARTICULOS a 
 WHERE e.T# = a.T# 
   AND EXISTS (SELECT * 
          FROM PROVEEDORES p 
         WHERE p.Ciudad != a.Ciudad 
           AND p.P# = e.P# 
           AND p.Ciudad != 'MADRID'); 


select distinct T# 
from ENVIOS
where C# in (select C# 
from ENVIOS 
group by C# 
having AVG(Cantidad)>320)


select C#
from ENVIOS
where P#='P2' and T#='T2'



select * 
from envios 
where C# in(select C# from COMPONENTES where Color <> 'ROJO')

SELECT e.* 
  FROM ENVIOS e, COMPONENTES c 
 WHERE e.C# = c.C# 
   AND Color <> 'ROJO'; 


 SELECT C#
 FROM ENVIOS 
 WHERE T#='T1'
 INTERSECT
 SELECT C#
 FROM ENVIOS
 WHERE T#='T2'


SELECT P#, COUNT(C#) CANTIDAD
FROM ENVIOS
WHERE C# IN (SELECT C# FROM COMPONENTES WHERE Color='ROJO')
GROUP BY P#

SELECT P#, COUNT(ENVIOS.C#) CANT
FROM ENVIOS 
INNER JOIN COMPONENTES ON COMPONENTES.C#=ENVIOS.C#
WHERE Color='ROJO'
GROUP BY P#

SELECT DISTINCT Color 
from ENVIOS
INNER JOIN COMPONENTES ON COMPONENTES.C#=ENVIOS.C#
WHERE P#='P1'

SELECT DISTINCT Color 
FROM COMPONENTES 
WHERE C# IN (SELECT DISTINCT C#  
          FROM ENVIOS  
               WHERE P# = 'P1'); 


SELECT ENVIOS.*, PROVEEDORES.Ciudad
FROM ENVIOS
INNER JOIN PROVEEDORES ON PROVEEDORES.P#=ENVIOS.P#
INNER JOIN COMPONENTES ON COMPONENTES.C# = ENVIOS.C#
INNER JOIN ARTICULOS ON ARTICULOS.T# = ENVIOS.T#
WHERE PROVEEDORES.Ciudad=COMPONENTES.Ciudad 
and PROVEEDORES.Ciudad=ARTICULOS.Ciudad 
and COMPONENTES.Ciudad=ARTICULOS.Ciudad

SELECT e.*, c.Ciudad 
  FROM ENVIOS e, COMPONENTES c, ARTICULOS a, PROVEEDORES p 
 WHERE e.T# = a.T# 
   AND e.C# = c.C# 
   AND e.P# = p.P# 
   AND p.Ciudad = c.Ciudad 
   AND p.Ciudad = a.Ciudad; 


SELECT Cnombre
FROM COMPONENTES
WHERE COMPONENTES.C# IN (SELECT C# 
FROM ENVIOS 
GROUP BY C# 
HAVING SUM(CANTIDAD)>500)


SELECT DISTINCT ENVIOS.P#
FROM ENVIOS 
INNER JOIN PROVEEDORES ON PROVEEDORES.P# = ENVIOS.P#
WHERE Ciudad='SEVILLA' 
AND ENVIOS.P# in (select P#
from ENVIOS 
group by P#
having count(distinct T#)<=2)

SELECT P# 
FROM PROVEEDORES 
WHERE Ciudad = 'SEVILLA' 
AND EXISTS (SELECT P# 
FROM ENVIOS 
GROUP BY P# 
HAVING COUNT(DISTINCT T#) <= 2 )


SELECT ENVIOS.T#
FROM ENVIOS 
INNER JOIN COMPONENTES ON COMPONENTES.C# = ENVIOS.C#
GROUP BY T# 
HAVING count(distinct Ciudad) = 1


select DISTINCT T# 
FROM ENVIOS
WHERE T# IN (SELECT T# 
FROM ENVIOS 
GROUP BY T# 
HAVING COUNT(DISTINCT C#)=(SELECT COUNT(C#)FROM COMPONENTES))

SELECT T# 
  FROM ENVIOS 
 GROUP BY T# 
HAVING COUNT(DISTINCT C#) = (SELECT COUNT(*) FROM COMPONENTES); 


SELECT DISTINCT P#, T#
FROM ENVIOS
INNER JOIN COMPONENTES ON COMPONENTES.C# = ENVIOS.C#
WHERE Color='ROJO'
GROUP BY P#,T#
HAVING COUNT(DISTINCT ENVIOS.C#)>=2

SELECT P#, T# 
  FROM ENVIOS e, COMPONENTES c 
 WHERE e.C# = c.C# 
   AND c.Color = 'ROJO' 
 GROUP BY P#, T# 
HAVING COUNT(*) > 1; 



SELECT distinct P# 
FROM ENVIOS
WHERE C# IN (SELECT C# 
				FROM ENVIOS 
				WHERE P# IN (SELECT P# 
							FROM ENVIOS 
							INNER JOIN COMPONENTES ON COMPONENTES.C#=ENVIOS.C# 
							WHERE Color='ROJO'))

SELECT DISTINCT P# 
  FROM ENVIOS 
 WHERE C# IN (SELECT C# 
                FROM ENVIOS 
               WHERE P# IN (SELECT e.P# 
                              FROM ENVIOS e, COMPONENTES c 
                             WHERE c.Color = 'ROJO' 
                               AND c.C# = e.C#)); 

20.	Seleccionar los identi?cadores de proveedores 
que hayan realizado algún envío con Cantidad mayor que la media 
de los envíos realizados para el componente a que corresponda dicho envío.
select distinct P#
FROM ENVIOS as e1
WHERE Cantidad >(SELECT AVG(Cantidad) FROM ENVIOS as e2 GROUP BY C# having e1.C#= e2.C#)

SELECT DISTINCT P# 
  FROM ENVIOS a 
 WHERE Cantidad > (SELECT AVG(Cantidad)  
                     FROM ENVIOS b  
                    WHERE b.C# = a.C#); 